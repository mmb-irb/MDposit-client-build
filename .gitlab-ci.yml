image: node:16

cache:
  paths:
    - node_modules/

stages:
  - build
  - deploy

before_script:
  - apt-get update && apt-get install -y curl
  - |
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm install 16.19.1
    nvm use 16.19.1
    node -v
    npm -v

build_job:
  stage: build
  script:
    - git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@mmb.irbbarcelona.org/gitlab/d.beltran.anadon/mdposit_client.git
    - cp NODE_ID/host-config.js mdposit_client/src
    - cd mdposit_client
    - touch .env
    - npm install
    - npm run build
    - cp -r build ../build
  artifacts:
    paths:
      - build
  only:
    changes:
      - NODE_ID/host-config.js

deploy_job:
  stage: deploy
  script:
    - cd NODE_ID
    - git config --global user.email "genis.bayarri@irbbarcelona.org"
    - git config --global user.name "Automatic CI/CD"
    - git clone https://oauth2:${GITLAB_ACCESS_TOKEN}@mmb.irbbarcelona.org/gitlab/gbayarri/mdposit-client-build.git
    - cd mdposit-client-build
    - cp -r ../../build ./NODE_ID
    - cd NODE_ID
    - zip -r build.zip build
    - git add build build.zip
    - git commit -m "Deploy new build for NODE_ID"
    - git push origin main
  only:
    changes:
      - NODE_ID/host-config.js